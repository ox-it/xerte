<script type="text/javascript">
/**
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.

 * The Apereo Foundation licenses this file to you under the Apache License,
 * Version 2.0 (the "License"); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at:
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.

 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

	// pageChanged & sizeChanged functions are needed in every model file
	// other functions for model should also be in here to avoid conflicts
	var dragDropLabel = new function() {
		var labelTxt1,
			labelTxt2,
			labelTxt3,
			targetTxt1,
			targetTxt2;

		// function called every time the page is viewed after it has initially loaded
		this.pageChanged = function() {
			var resize = $("#labelHolder .label").length == $("#labelHolder .label.ui-draggable-disabled").length && x_currentPageXML.getAttribute("labelPos") != "text" ? true : false;
			this.createLabels();
			if (resize) {
				this.sizeChanged();
			}
		}

		// function called every time the size of the LO is changed
		this.sizeChanged = function(firstLoad) {
			$x_pageHolder.scrollTop(0);
			var $panel = $("#mainPanel");

			if (firstLoad == true) {
				firstLoad = false;
				this.createLabels();
			} else {
				// resize image to max that will fit space
				var $image = $("#image"),
					prevW = $image.width(),
					labelHolderH = x_currentPageXML.getAttribute("labelPos") != "text" ? $("#labelHolder").height() : 0,
					imgSize = x_currentPageXML.getAttribute("imgWidth") == undefined || x_currentPageXML.getAttribute("imgWidth") == "Medium" ? 0.5 : x_currentPageXML.getAttribute("imgWidth") == "Small" ? 0.3 : 0.8;
				
				x_scaleImg($image, $x_pageHolder.width() * imgSize, $x_pageHolder.height() - (parseInt($x_pageDiv.css("padding-top")) * 2) - (parseInt($("#mainPanel").css("padding-top")) * 2) - labelHolderH - 10);
				$("#labelHolder").width($image.width());

				// adjust target sizes and positions
				var scale = $image.width() / prevW;
				$("#targetHolder .target").each(function() {
					var $this = $(this);
					$this.css({
						"left"		:$this.position().left * scale,
						"top"		:$this.position().top * scale,
						"width"		:$this.width() * scale,
						"height"	:$this.height() * scale
					});
				});
				
				// also adjust labels
				$("#labelHolder .ui-draggable-disabled").each(function() {
					var $this = $(this);
					$this.css({
						"left"		:$this.data("target").position().left + 2 + $panel.position().left,
						"top"		:$this.data("target").position().top + 2 + $panel.position().top
					});
				});
			}
		}

		this.init = function() {
			// store strings used to give titles to labels and targets when keyboard is being used (for screen readers)
			labelTxt1 = x_getLangInfo(x_languageData.find("interactions").find("draggableItem")[0], "name", "Draggable Item");
			labelTxt2 = x_getLangInfo(x_languageData.find("interactions").find("draggableItem")[0], "selected", "Item Selected");
			labelTxt3 = x_getLangInfo(x_languageData.find("interactions").find("draggableItem")[0], "toSelect", "Press space to select");
			targetTxt1 = x_getLangInfo(x_languageData.find("interactions").find("targetArea")[0], "description", "Drop zone for");
			targetTxt2 = x_getLangInfo(x_languageData.find("interactions").find("targetArea")[0], "toSelect", "Press space to drop the selected item.");

			$("#mainText").html(x_addLineBreaks(x_currentPageXML.getAttribute("text")));
			
			if (x_currentPageXML.getAttribute("labelPos") == "text") {
				$("#mainText")
					.after($("#labelHolder"))
					.after('<hr/>');
			}

			var tryTxt = x_currentPageXML.getAttribute("tryAgainTxt");
			if (tryTxt == undefined || tryTxt == "") {
				tryTxt = "Try again";
			}
			$("#pageContents").data("tryTxt", tryTxt);

			if (x_currentPageXML.getAttribute("align") == "Right") {
				$("#dragDropHolderLabelling").addClass("x_floatLeft");
			} else {
				$("#dragDropHolderLabelling").addClass("x_floatRight");
			}

			this.sizeChanged(true);
		}

		this.createLabels = function() {
			var	$labelHolder = $("#labelHolder"),
				tempData = [];

			$labelHolder.empty();
			$("#infoHolder").html("");
			$("#pageContents").data("selectedLabel", "");

			$(x_currentPageXML).children()
				.each(function(i) {
					tempData.push({name:this.getAttribute("name"), text:this.getAttribute("text"), correct:i});
				});

			// randomise order and create labels
			$(x_currentPageXML).children()
				.each(function(i) {
					var labelNum = Math.floor(Math.random() * tempData.length);

					$('<div class="label panel" id="label' + i + '" tabindex="' + (i+3) + '" title="' + labelTxt1 + '">' + tempData[labelNum].name + '</div>')
						.appendTo($labelHolder)
						.data("correct", tempData[labelNum].correct);

					tempData.splice(labelNum, 1);
				});

			// set up drag events (mouse and keyboard controlled)
			$("#labelHolder .label")
				.draggable({
					containment:	"#x_pageHolder",
					stack:			"#labelHolder .label", // item being dragged is always on top (z-index)
					revert:			"invalid", // snap back to original position if not dropped on target
					start:			function() {
						// remove any focus/selection highlights made by tabbing to labels/targets
						var $pageContents = $("#pageContents");
						if ($("#labelHolder .label.focus").length > 0) {
							$("#labelHolder .label.focus").attr("title", labelTxt1);
						}
						if ($pageContents.data("selectedLabel") != undefined && $pageContents.data("selectedLabel") != "") {
							$pageContents.data("selectedLabel").attr("title", labelTxt1);
							$pageContents.data("selectedLabel", "");
						}
						var targetInFocus = $("#targetHolder .target.highlight");
						if (targetInFocus.length > 0) {
							targetInFocus.attr("title", targetTxt1 + " " + (targetInFocus.index() + 1));
						}
						$("#labelHolder .selected").removeClass("selected");
						$("#labelHolder .focus").removeClass("focus");
						$("#labelHolder .highlight").addClass("transparent").removeClass("highlight");

						$("#infoHolder").html("");
					},
					stop:			function() {
						if ($(this).data("success") != true) {
							$("#infoHolder").html($("#pageContents").data("tryTxt"));
						}
					}
					})
				// set up events used when keyboard rather than mouse is used
				// these highlight selected labels / targets and set the title attr which the screen readers will use
				.focusin(function() {
					var $this = $(this);
					if ($this.is($("#pageContents").data("selectedLabel")) == false) {
						$this
							.addClass("focus")
							.attr("title", labelTxt1 + " - " + labelTxt3);
					}
					})
				.focusout(function() {
					var $this = $(this);
					$this.removeClass("focus");
					if ($this.is($("#pageContents").data("selectedLabel")) == false) {
						$this.attr("title", labelTxt1);
					}
					})
				.keypress(function(e) {
					var charCode = e.charCode || e.keyCode;
					if (charCode == 32) {
						var $pageContents = $("#pageContents");
						if ($pageContents.data("selectedLabel") != undefined && $pageContents.data("selectedLabel") != "") {
							$pageContents.data("selectedLabel")
								.removeClass("selected")
								.attr("title", labelTxt1);
						}
						var $this = $(this);
						$this
							.removeClass("focus")
							.addClass("selected")
							.attr("title", labelTxt1 + ' - ' + labelTxt2);
						$pageContents.data("selectedLabel", $this);

						$("#infoHolder").html("");
					}
					})
				.disableSelection();

			if ($("#image").attr("src") == undefined) {
				// image can load now as we know what its max dimensions are
				$("#image")
					.one("load", function() {
						dragDropLabel.imgLoaded();
					})
					.attr({
						"src"	:x_evalURL(x_currentPageXML.getAttribute("url")),
						"alt"	:x_currentPageXML.getAttribute("tip")
					})
					.each(function() { // called if loaded from cache as in some browsers load won't automatically trigger
						if (this.complete) {
							$(this).trigger("load");
						}
					});

			} else {
				// labels are being reset - make sure targets will still accept them being dropped
				$("#targetHolder .target")
					.each(function() {
						var $this = $(this);
						$this.droppable({
							tolerance: "pointer",
							accept:	$("#labelHolder .label").filter(function() {return $(this).data("correct") == $this.index();})
						});
					})
					.off("click");
			}
		}

		this.imgLoaded = function() {
			// labels have been created and image loaded - can now resize image to fit space and create targets on it
			var $image = $("#image"),
				labelHolderH = x_currentPageXML.getAttribute("labelPos") != "text" ? $("#labelHolder").height() : 0,
				imgSize = x_currentPageXML.getAttribute("imgWidth") == undefined || x_currentPageXML.getAttribute("imgWidth") == "Medium" ? 0.5 : x_currentPageXML.getAttribute("imgWidth") == "Small" ? 0.3 : 0.8;
			
			x_scaleImg($image, $x_pageHolder.width() * imgSize, $x_pageHolder.height() - (parseInt($x_pageDiv.css("padding-top")) * 2) - (parseInt($("#mainPanel").css("padding-top")) * 2) - labelHolderH - 10, true, true);
			$("#labelHolder").width($image.width());
			
			var scale = $image.width() / $image.data("origSize")[0],
				$targetHolder = $("#targetHolder");
			
			// create targets
			$(x_currentPageXML).children()
				.each(function(i) {
					var xywh = [Number(this.getAttribute("x")), Number(this.getAttribute("y")), Number(this.getAttribute("w")), Number(this.getAttribute("h"))];

					// adjust xywh so hotspots don't overlap image edges
					if (xywh[0] < 0) {
						xywh.splice(2, 1, xywh[2] + xywh[0]);
						xywh.splice(0, 1, 0);
					}
					if (xywh[1] < 0) {
						xywh.splice(3, 1, xywh[3] + xywh[1]);
						xywh.splice(1, 1, 0);
					}
					if (xywh[0] + xywh[2] > $image.data("origSize")[0]) {
						xywh.splice(2, 1, $image.data("origSize")[0] - xywh[0]);
					}
					if (xywh[1] + xywh[3] > $image.data("origSize")[1]) {
						xywh.splice(3, 1, $image.data("origSize")[1] - xywh[1]);
					}

					// now adjust for resized image
					xywh = [xywh[0] * scale, xywh[1] * scale, xywh[2] * scale, xywh[3] * scale];

					// create target and position it
					$('<div class="target transparent"></div>')
						.appendTo($targetHolder)
						.attr("title", targetTxt1 + " " + (i + 1))
						.data("text", this.getAttribute("text"))
						.css({
							"left"		:xywh[0],
							"top"		:xywh[1],
							"width"		:xywh[2],
							"height"	:xywh[3]
						})
						.droppable({
							tolerance: "pointer",
							// only correct label can be dropped on target
							accept:	$("#labelHolder .label").filter(function() {return $(this).data("correct") == i;})
						});
				});

			var $targets = $("#targetHolder .target");

			// add border to targets
			if (x_currentPageXML.getAttribute("showHighlight") != "false") {
				var highlightColour = "yellow";
				if (x_currentPageXML.getAttribute("highlightColour") != undefined && x_currentPageXML.getAttribute("highlightColour") != "") {
					highlightColour = x_getColour(x_currentPageXML.getAttribute("highlightColour"));
				}
				$targets
					.addClass("border")
					.css("border-color", highlightColour);
			}

			$targets
				.droppable({
					tolerance: "pointer",
					drop:	function(event, ui) {
						dragDropLabel.dropLabel($(this), ui.draggable); // target, label
						ui.draggable.data("success", true);
					}
					})
				.focusin(function(e) {
					$(this)
						.addClass("highlight")
						.removeClass("transparent");
					var $pageContents = $("#pageContents");
					if ($pageContents.data("selectedLabel") != undefined && $pageContents.data("selectedLabel") != "") {
						$(this).attr("title", targetTxt1 + " " + ($(this).index() + 1) + " - " + targetTxt2);
					}
					})
				.focusout(function() {
					var $pageContents = $("#pageContents");
					$(this)
						.addClass("transparent")
						.removeClass("highlight")
						.attr("title", targetTxt1 + " " + ($(this).index() + 1));
					})
				.keypress(function(e) {
					var charCode = e.charCode || e.keyCode;
					if (charCode == 32) {
						var $pageContents = $("#pageContents");
						var $selectedLabel = $pageContents.data("selectedLabel");
						if ($selectedLabel != undefined && $selectedLabel != "") {
							// only accept drops for correct answers
							if ($selectedLabel.data("correct") == $(this).index()) {
								dragDropLabel.dropLabel($(this), $selectedLabel); // target, label
							} else {
								$(this).attr("title", targetTxt1 + " " + ($(this).index() + 1));
								$selectedLabel
									.removeClass("selected")
									.attr("title", labelTxt1);

								$("#infoHolder").html($pageContents.data("tryTxt"));
								$pageContents.data("selectedLabel", "");
							}
						}
					}
				});

			// set tab index for targets - leaving space between them for a label to be put on it
			var tabIndex = 2;
			tabIndex += $("#labelHolder .label").length;
			$targets.each(function() {
				tabIndex++;
				var $this = $(this);
				$this.attr("tabindex", tabIndex);
				tabIndex++;
			});

			x_pageLoaded();
		}

		// function called when label dropped on target - by mouse or keyboard
		this.dropLabel = function($thisTarget, $thisLabel) {
			$x_pageHolder.scrollTop(0);
			var $infoHolder = $("#infoHolder");
			$infoHolder.html('<h3>' + $thisLabel.html() + '</h3><p>' + x_addLineBreaks($thisTarget.data("text")) + '</p>');

			$thisLabel
				.attr({
					"title"		:labelTxt1,
					"tabindex"	:$thisTarget.attr("tabindex") + 1,
					"style"		:"cursor: pointer !important;" // need to use !important as jQuery ui styles make cursor default !important - doing another !important is the only way to override it
				})
				.data("infoTxt", $infoHolder.html())
				.removeClass("selected")
				.draggable("disable")
				.css({
					"opacity"	:1,
					"position"	:"absolute",
					"top"		:$thisTarget.position().top + 2 + $("#mainPanel").position().top,
					"left"		:$thisTarget.position().left + 2 + $("#mainPanel").position().left
				})
				.off("keypress focusin focusout")
				.click(function() {
					$("#infoHolder").html($(this).data("infoTxt"));
				})
				.focusin(function() {
					$(this).addClass("focus");
					$("#infoHolder").html($(this).data("infoTxt"));
				})
				.focusout(function() {
					$(this).removeClass("focus");
					$("#infoHolder").html("");
				})
				.data("target", $thisTarget);

			$thisTarget
				.attr("title", targetTxt1 + " " + ($thisTarget.index() + 1))
				.data("infoTxt", $infoHolder.html())
				.css("cursor", "pointer")
				.click(function() {
					$("#infoHolder").html($(this).data("infoTxt"));
				});
			
			if ($("#labelHolder .label").length == $("#labelHolder .label.ui-draggable-disabled").length) {
				$("#pageContents hr:eq(1)").remove();
			}
			
			$("#pageContents").data("selectedLabel", "");
		}
	}

	dragDropLabel.init();

</script>

<style type="text/css">

	#textHolder {
		margin-bottom:	10px;
	}
	
	.borderTop {
		border-top:		1px solid gray;
		margin-top:		20px;
		padding-top:	20px;
	}

	#mainPanel {
		position:	relative;
	}

	#mainPanel #labelHolder {
		margin-top:	10px;
	}
	
	#dragDropHolderLabelling #labelHolder {
		clear: both;
		float:left;
	}

	#labelHolder .label {
		display:	inline-block;
		cursor:		pointer;
		padding:	5px;
		margin:		10px;
	}

	#labelHolder .label.focus {
		border:		2px solid yellow;
	}

	#labelHolder .label.selected {
		border:		2px solid green;
	}

	#targetHolder {
		position:	absolute;
		margin:		10px;
		top:		0;
		left:		0;
	}

	#targetHolder .target {
		position:	absolute;
	}

	#targetHolder .target.border {
		border:	1px solid;
	}
	
	#pageContents hr {
		border: none;
		background-color: #CCCCCC;
		height: 1px;
	}

</style>

<div id="pageContents">
	
	<div id="dragDropHolderLabelling">
		<div id="mainPanel" class="panel">
			<img id="image" />
			<div id="targetHolder"></div>
		</div>
		<div id="labelHolder"></div>
	</div>
	
	<div id="textHolder">
		<div id="mainText" tabindex="1"></div>
		<hr/>
		<div id="infoHolder" tabindex="2"></div>
	</div>
	
</div>